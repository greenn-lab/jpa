# í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬

## 1. í”„ë¡ì‹œ

íšŒì›ê³¼ íŒ€ ì—”í‹°í‹°ê°€ ì¡´ì¬ í•  ë•Œ, íšŒì›ì„ ì¡°íšŒí•˜ë©´ íŒ€ ê¹Œì§€ ì¡°íšŒ ë˜ëŠ”ê²Œ ë¹„íš¨ìœ¨ì ì´ë¼ê³  ìƒê°í•´ì„œ íšŒì› ì—”í‹°í‹°ì˜ `member.getTeam()` ê³¼ ê°™ì´ ì‹¤ì œì ìœ¼ë¡œ íŒ€ ì—”í‹°í‹°ê°€ í•„ìš”í•œ ì‹œì ì— ì‹¤í–‰(ì§€ì—°ë¡œë”©)í•  ìˆ˜ ìˆëŠ” ê°€ì§œ ê°ì²´ë¥¼ "í”„ë¡ì‹œ ê°ì²´"ë¼ í•œëŒ€ìš”.

### 1.1 í”„ë¡ì‹œ ê¸°ì´ˆ

í”„ë¡ì‹œ ê°ì²´ë¥¼ ì§ì ‘ êº¼ë‚´ì„œ ì“°ê³  ì‹¶ë‹¤ë©´ (ì‹¤ì œ ì‚¬ìš© ì‹œì ê¹Œì§€ ì§€ì—°í•´ì„œ ë¡œë”©í•˜ê³  ì‹¶ë‹¤ë©´) ì €ë ‡ê²Œ í•˜ë©´ ëœëŒ€ìš”.

```java
Member member = em.getReference(Member.class, 1L);
```

ì €ë ‡ê²Œ ë˜ë©´ `member.getName()` ê°™ì´ **ì‹¤ì œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ë•Œ, DBë¥¼ ì¡°íšŒí•´ì„œ ê°ì²´ë¥¼ ìƒì„±** í•˜ê³ , ì´ë¥¼ **_í”„ë¡ì‹œ ê°ì²´ì˜ ì´ˆê¸°í™”_** ë¼ê³  ë¶€ë¥´êµ°ìš”.

### 1.2 í”„ë¡ì‹œì™€ ì‹ë³„ì

ì¢€ í—·ê°ˆë¦¬ê²Œ ì¨ì£¼ì…¨ì§€ë§Œ, `em.getReference(...)` í™œìš©í•´ì„œ ì‹ë³„ì ê°’ë§Œ í™œìš©í•´ì„œ DB ì ‘ê·¼ íšŸìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆê² ë„¤ìš”.

```java
Member member = em.find(Member.class, 1L);
Team team = em.getReference(Team.class, "TeamID");

member.setTeam(team);
```

### 1.3 í”„ë¡ì‹œ í™•ì¸

`PersistenceUnitUtil.isLoaded(Object entity)` ë¥¼ ì´ìš©í•˜ë©´ í”„ë¡ì‹œ ê°ì²´ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì´ˆê¸°í™” ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆëŒ€ìš”.  
**ì´ë¯¸ ì´ˆê¸°í™” ë˜ì—ˆê±°ë‚˜ í”„ë¡ì‹œ ê°ì²´ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì•„ë‹ˆë©´** `true` !

<br>

## 2. ì¦‰ì‹œ ë¡œë”©ê³¼ ì§€ì—° ë¡œë”©

### 2.1 ì¦‰ì‹œ ë¡œë”©

```java
#Entity
class Member {
  @ManyToOne(fetch = FetchType.EAGER)
  @JoinColumn(name = "TEAM_ID")
  private Team team;
}
```

ì´ëŸ° ì—”í‹°í‹°ë¥¼ ì¡°íšŒ í•˜ë©´,

```java
Member member = em.find(Member.class, 1L);
Team team = member.getTeam();
```

ì´ëŸ¬ë©´ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ê°€

```SQL
    SELECT M.MEMBER_ID,
           M.TEAM_ID,
           M.USERNAME,
           T.TEAM_ID,
           T.NAME
      FROM MEMBER M
LEFT OUTER
      JOIN TEAM T
        ON M.TEAM_ID = T.TEAM_ID
     WHERE M.MEMBER_ID = 1
```

ì£¼ëª©í•  ì ì´ **OUTER JOIN** ì„ ì‚¬ìš©í–ˆë‹¤ëŠ” ê±´ë°, INNER JOIN ì„ í•˜ê²Œ í•˜ë ¤ë©´

- `@JoinColumn(id = ..., nullable = false)`
- `@ManyToOne(fetch = FetchType.EAGER, optional = false)`

ì´ëŸ° ê²ƒë“¤ì„ ì‚¬ìš©í•˜ë©´ ëœëŒ€ìš”. ì €ê²ƒë“¤ì´ ì„ íƒì /í•„ìˆ˜ì  ê´€ê³„ë¥¼ ëª…ì‹œí•˜ëŠ”ê±´ë°, **ì„ íƒì  ê´€ê³„ë©´ OUTER JOIN** ì„, **í•„ìˆ˜ì  ê´€ê³„ë©´ INNER JOIN** ì„ ì‚¬ìš©í•œëŒ€ìš”.

### 2.2 ì§€ì—° ë¡œë”©

```java
@Entity
class Member {
  @ManyToOne(fetch = FetchType.LAZY)
  @JoinColumn(name = "TEAM_ID")
  private Team team;
  ...
}
```

ì´ë ‡ê²Œ ì—”í‹°í‹° ë§¤í•‘ì„ í•˜ê³ ,

```java
Member member = em.find(Member.class, 1L);
Team team = member.getTeam();

String teamName = team.getName(); // ì‹¤ì œë¡œ team ê°ì²´ ì‚¬ìš©
```

ì €ê¸°ì—ì„œ `team` ì¸ìŠ¤í„´ìŠ¤ëŠ” í”„ë¡ì‹œ ê°ì²´ì´ê³  ì‹¤ì œë¡œ ì‚¬ìš©í•˜ê¸° ì „ê¹Œì§€ëŠ” ë°ì´í„° ë¡œë”©ì„ ë¯¸ë¤„ë‘”ëŒ€ìš”.  
`em.find(Member.class 1L)` ì´ ì‹¤í–‰ ë ë•Œ

```SQL
    SELECT *
      FROM MEMBER
     WHERE MEMBER_ID = 1
```

ì´ëŸ° SQL ì´ ì‹¤í–‰ë˜ê³ , `team.getTeam()` ì´ ì‹¤í–‰ë˜ë©´ ê·¸ë•Œ ë‹¤ìŒ SQL ì´ ì‹¤í–‰ëœëŒ€ìš”.

```SQL
    SELECT *
      FROM TEAM
     WHERE TEAM_ID = 'TeamID'
```

### 2.3 ì¦‰ì‹œë¡œë”©, ì§€ì—°ë¡œë”© ì •ë¦¬

ì±…ì— ì¢‹ì€ ë§ì”€ ì¨ì£¼ì…¨ë„¤ìš”. ê·¼ë°, í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ê°€ëŠ¥í•˜ë©´ ì¦‰ì‹œë¡œë”©(EAGER)ì„ í•˜ë ¤ê³  í•œëŒ€ìš”. ì™œ ê·¸ëŸ´ê¹Œìš”?ğŸ¤”

<br>

### 3. ì§€ì—° ë¡œë”© í™œìš©

![](08_001.svg)

ê´€ê³„ëŠ” ëŒ€ì¶© ë³´ë©´ ì•„ì‹œê² ì£ ?  
ì‚¬ìš© ë¹ˆë„ê°€ ìˆì–´ì„œ ì¡°ê±´ì€ ì´ë ‡ê²Œ ì¤¬ëŠ”ë°,

- Memberì˜ Teamì€ ìì£¼ ì‚¬ìš©ë˜ì–´, ì¦‰ì‹œë¡œë”©
- Memberì˜ OrderëŠ” ê°€ë” ì‚¬ìš©ë˜ì–´, ì§€ì—°ë¡œë”©
- Orderì˜ ProductëŠ” í•¨ê»˜ ì‚¬ìš©ë˜ë‹ˆê¹Œ, ì¦‰ì‹œë¡œë”©

ì—”í‹°í‹°ë¥¼ ë§Œë“¤ì–´ ë³´ì•„ìš”~

```java
@Entity
class Member {
  @Id @GeneratedValue
  @Column(name = "MEMBER_ID")
  private Long id;
  private String userName;

  @ManyToOne(fetch = FetchType.EAGER)
  @JoinColumn(name = "TEAM_ID")
  private Team team;

  @OneToMany(mappedBy = "member", fetch = FetchType.LAZY)
  private List<Order> orders = new ArrayList<>();
  ...
}
```

`Member` ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ë©´ SQLì€,

```SQL
    SELECT M.MEMBER_ID,
           M.TEAM_ID,
           M.USER_NAME,
           T.ID,
           T.NAME
      FROM MEMBER M
      LEFT
OUTER JOIN TEAM T
     WHERE M.MEMBER_ID = 1
```

### 3.1 í”„ë¡ì‹œì™€ ì»¬ë ‰ì…˜ ë˜í¼

ìœ„ì˜ ì—”í‹°í‹°ì—ì„œ `member.getOrders()` ë¥¼ ì‹¤í–‰í•˜ë©´ `org.hibernate.collection.internal.PersistentBag` íƒ€ì…ì˜ ê°ì²´ê°€ íŠ€ì–´ ë‚˜ì˜¨ëŒ€ìš”.
ì´ëŠ” ì»¬ë ‰ì…˜ì˜ ë³€ê²½ ê°ì§€, ì¶”ì  ë“±ì˜ ëª©ì ìœ¼ë¡œ **ì»¬ë ‰ì…˜ ë˜í¼** ë¥¼ ì“°ê¸° ë•Œë¬¸ì´ë˜ìš”.

### 3.2 JPA ê¸°ë³¸ í˜ì¹˜ ì „ëµ

- **@ManyToOne**, **@OneToOne** ì¦‰ì‹œ ë¡œë”© (FetchType.EAGER)
- **@OneToMany**, **@ManyToMany** ì§€ì—° ë¡œë”© (FetchType.LAZY)

ì—°ê´€ëœ ì—”í‹°í‹°ê°€ **ë‹¨ì¼ ê°ì²´ë©´ ì¦‰ì‹œ ë¡œë”©**, **ì»¬ë ‰ì…˜ì´ë©´ ì§€ì—° ë¡œë”©** ì¸ê²Œ JPAì˜ ê¸°ë³¸ í˜ì¹˜<sub>fetch</sub> ì „ëµ ì´ë˜ìš”.  
í•˜ì§€ë§Œ ì±…ì—ì„œ ì¶”ì²œí•˜ëŠ” ê±´ **_ëª¨ë“  ê²ƒì— ì§€ì—°ë¡œë”©ì„ ì‚¬ìš©_** í•˜ë˜ìš”.

### 3.3 ì»¬ë ‰ì…˜ì— FetchType.EAGER ì‚¬ìš© ì‹œ ì£¼ì˜ì 

**ì»¬ë ‰ì…˜ì„ í•˜ë‚˜ ì´ìƒ ì¦‰ì‹œ ë¡œë”©í•˜ëŠ” ê²ƒì€ ê¶Œì¥ ì•ˆí•¨!**  
ë‹¹ì—°í•œ ê²ƒ ê°™ìœ¼ë‹ˆê¹Œ ëŒ€ì¶© ë„˜ì–´ê°ˆê²Œìš”. ì„±ëŠ¥ ë¬¸ì œê°€ ìƒê¸°ê³ , ë„ˆë¬´ ë§ì€ ê²°ê³¼ëŠ” ë©”ëª¨ë¦¬ì—ì„œ í•„í„°ë§ í•´ì„œ ë°˜í™˜í•´ ì¤€ë‹¤ëŠ”ë°...

**ì»¬ë ‰ì…˜ ì¦‰ì‹œ ë¡œë”©ì€ í•­ìƒ ì™¸ë¶€ ì¡°ì¸<sub>outer join</sub>ì„ ì‚¬ìš©**  
ì¢€ ë³µì¡í•œ ì–˜ê¸´ë°, ë‚´ë¶€ ì¡°ì¸ì„ í•˜ë©´ ê´€ê³„ê°€ ë§ì¶°ì ¸ ìˆëŠ” ë°ì´í„°ë§Œ ì¡°íšŒê°€ ë˜ì–ì•„ìš”. ê·¸ë˜ì„œ íŒ€ì„ ì¡°íšŒí•  ë•Œ, íšŒì›ì´ ì—†ëŠ” íŒ€ì€ ì¡°íšŒ ì•ˆë˜ëŠ” ê²½ìš°ê°€ ìƒê¸´ë°ìš”. got it?!ğŸ‘Œ

<br>

### 4. ì˜ì†ì„± ì „ì´: CASCADE

í¬.. ë“œë””ì–´ ìš°ë¦¬ê°€ ì°¾ë˜ ê¸°ëŠ¥ì´ ì™”ìŠµë‹ˆë‹¤. ì˜ì†ì„± ì „ì´<sub>transitive persistence</sub> ê¸°ëŠ¥ ë§ì˜ˆìš”.

![](08_002.svg)

```java
@Entity
class Parent {
  @Id @GeneratedValue
  private Long id;

  @OneToMany(mappedBy = "parent")
  private List<Child> children = new ArrayList<>();
  ...
}
```

```java
@Entity
class Child {
  @Id @GeneratedValue
  private Long id;

  @ManyToOne
  private Parent parent;
}
```

ì´ëŸ° ì—”í‹°í‹°ê°€ ìˆì—ˆë“œë¬ì£ . ì´ê±¸ `Parent` ê°€ 1ëª… ìˆê³ , `Child` ê°€ 2ê°œ ìˆëŠ” ê±¸ ë§Œë“¤ë©´,

```java
Parent parent = new Parent();
em.persist(parent);

Child child1 = new Child();
child1.setParent(parent);
em.persist(child1);

Child child2 = new Child();
child2.setParent(parent);
em.persist(child2);
```

**JPAì—ì„œ ì—”í‹°í‹°ë¥¼ ì €ì¥í•  ë•Œ ì—°ê´€ëœ ëª¨ë“  ì—”í‹°í‹°ëŠ” ì˜ì† ìƒíƒœì—¬ì•¼ í•œë‹¤** ì–ì•„ìš”. ê·¸ë˜ì„œ ë¶€ëª¨ ë§Œë“¤ê³  ìì‹ ~~ìƒˆë¼~~ ë“¤ ë§Œë“¤ì–´ì„œ ë„£ì–ì•„ìš”, ì™œ. (ê·¼ë°, ì´ê±° ê·¸ëƒ¥ í•´ë„ ë˜ë˜ë°... hibernate ë²„ì „ ë•Œë¬¸ì¸ê°€... ì±…ì€ 4.3 ê¸°ì¤€ì´ì—ìš”.)

### 4.1 ì˜ì†ì„± ì „ì´: ì €ì¥

`Parent` ì—”í‹°í‹°ì—ì„œ,

```java
...
@OneToMany(mappedBy = "parent", cascade = CascadeType.PERSIST)
private List<Child> children = new ArrayList<>();
...
```

ì´ë ‡ê²Œ `CascadeType.PERSIST` ì†ì„±ì„ ì£¼ëŠ” ê±°ì£ . ê·¸ëŸ¬ë©´ ì €ì¥í•  ë•Œ ì €ë ‡ê²Œë„ ëœëŒ€ìš”.

```java
Child child1 = new Child();
Child child2 = new Child();

Parent parent = new Parent();

child1.setParent(parent);
child2.setParent(parent);

parent.getChildren().add(child1);
parent.getChildren().add(child2);

em.persist(parent);
```

ğŸ‘ğŸ‘ğŸ‘ ë¸Œë¼ë³´~!

### 4.2 ì˜ì†ì„± ì „ì´: ì‚­ì œ

ì§€ê¸ˆê¹Œì§€ ì‚­ì œ ê¸°ëŠ¥ì€ ì •ë§ ê°€ê´€ì´ì—ˆì£ .

```java
Parent parent = em.find(Parent.class, 1L);
Child child1 = em.find(Child.class, 1L);
Child child2 = em.find(Child.class, 2L);

em.remove(child1);
em.remove(Child2);
em.remove(parent);
```

ì´ê²Œ ë­ëŒ...  
í•˜ì§€ë§Œ `CascadeType.REMOVE` ê°€ ì„¤ì •ë˜ë©´,

```java
Parent parent = em.find(Parent.class, 1L);
em.remove(parent);
```

ğŸ‘ğŸ‘ğŸ‘ êµ¿ì¡~!

### 4.3 CASCADE ì¢…ë¥˜

- `ALL`
- `PERSIST`
- `MERGE`
- `REMOVE`
- `REFRESH`
- `DETACH`

ì´ëŸ° ì• ë“¤ì´ ìˆëŒ€ìš”.  
ì“°ì„ìƒˆëŠ” ì•„ì‹œê² ì£ ?!

<br>

## 5. ê³ ì•„ ê°ì²´

**ë¶€ëª¨ ì—”í‹°í‹°ì™€ ì—°ê²°ì´ ëŠì´ì§„ ìì‹ ì—”í‹°í‹°ë¥¼ ìë™ ì‚­ì œí•´ì£¼ëŠ” "ê³ ì•„ ê°ì²´ ì œê±°(orphan)** ê¸°ëŠ¥ì´ ìˆëŒ€ìš”.

**ë¶€ëª¨ ì—”í‹°í‹°ì˜ ì»¬ë ‰ì…˜ì—ì„œ ìì‹ ì—”í‹°í‹°ì˜ ì°¸ì¡°ë§Œ ì œê±°í•˜ë©´ ìì‹ ì—”í‹°í‹°ê°€ ìë™ìœ¼ë¡œ ì‚­ì œ** ë˜ëŠ” ë§¤ì§ì„ ì‹œí˜„í•´ ë³´ì¸ë‹µë‹ˆë‹¤.

```java
@Entity
class Parent {
  @Id @GeneratedValue
  private Long id;

  @OneToMany(mappedBy = "parent", orphanRemoval = true)
  private List<Child> children = new ArrayList<>();
  ...
}
```

ì´ë ‡ê²Œ `orphanRemoval = true` ì†ì„±ë§Œ ìˆìœ¼ë©´,

```java
Parent parent = em.find(Parent.class, 1L);
parent.getChildren().remove(0);
```

ì´ë ‡ê²Œ ì»¬ë ‰ì…˜ì—ì„œë§Œ ì§€ì› ëŠ”ë°,

```SQL
    DELETE
      FROM CHILD
     WHERE ID = ?
```

ì´ëŸ° SQL ì´ ì‹¤í–‰ ëœëŒ€ìš”.

<br>

## 6. ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´, ìƒëª…ì£¼ê¸°

`CascadeType.ALL` í•˜ê³  `orphanRemoval = true` ë¥¼ ê°™ì´ ì¨ë²„ë¦¬ë©´ ì–´ë–»ê²Œ ë êº¼ëƒê³  ë¬»ëŠ”ë‹¤... ğŸ˜· ìœ êµ¬ë¬´ì–¸...

ë¶€ëª¨ ì—”í‹°í‹°ê°€ ì•Œì•„ì„œ ìì‹ ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬ í•œëŒ€ìš”.  
ì™„ì „ ê°ì²´ ë‹¤ë£¨ë“¯ DBë„ ë‹¤ë£¨ëŠ”ê²Œ ë˜ëŠ” ê±°ê² ë„¤ìš”.

## 3. Criteria

JPQLì„ ì½”ë“œë¡œ ì‘ì„±í•˜ëŠ” ê±°êµ°ìš”. ë¹Œë“œ íŒ¨í„´ìœ¼ë¡œ ì˜¤íƒ€ ìœ ë°œ ë°©ì§€, ìë™ì™„ì„± ë˜ëŠ”ë° ë³µì¡í•˜ê³  ì¥í™©í•´ì„œ ë³„ë¡œë˜ìš”ğŸ˜µ

### 3.1 Criteria ê¸°ì´ˆ

```java
CriteriaBuilder db = em.getCriteriaBuilder();

CriteriaQuery<Member> cq = cb.createQuery(Member.class);

Root<Member> m = cq.from(Member.class)
cq.select(m);

TypedQuery<Member> query = em.createQuery(cq);
List<Member> members = query.getResultList();
```

ì•„ì§ì€ ë‹¨ìˆœí•´ì„œ ì§ê´€ì ìœ¼ë¡œ ì´í•´ê°€ ë˜ë„¤ìš”.  
ê²€ìƒ‰ ì¡°ê±´ì„ ë„£ì–´ ë³´ë©´,

```java
CriteriaBuilder cb = em.getCriteriaBuilder();

CriteriaQuery<Member> cq = cb.createQuery(Member.class);
Root<Member> m = cq.from(Member.class);

Predicate usernameEqual = cb.equal(m.get("username"), "ê²€ìƒ‰ì–´");
Order ageDesc = cb.desc(m.get("age"));

cq.select(m)
  .where(usernameEqual)
  .orderBy(ageDesc);

List<Member> members = em.createQuery(cq).getResultList();
```

ì´ë¯¸ ë³µì¡í•´ğŸ‘

ìˆ«ì íƒ€ì…ì„ ê²€ìƒ‰í•˜ë©´,

```java
Root<Member> m = cq.from(Member.class);

Predicate ageGt = cb.greaterThan(m.<Integer>get("age"), 10);

cq.select(m)
  .where(ageGt)
  .orderBy(cb.desc(m.get("age")));
```

`greaterThan` ëŒ€ì‹  `gt` ì¨ë„ ëœëŒ€ìš”.

### 3.2 Criteria ì¿¼ë¦¬ ìƒì„±

`Object` ë¡œ ì¡°íšŒí•˜ê³ , `Object[]` ë¡œ ë°˜í™˜ íƒ€ì…ì„ ì •í•  ìˆ˜ ìˆê³ , `Tuple` ë¡œë„ í•  ìˆ˜ ìˆëŒ€ìš”.

### 3.3 ì¡°íšŒ

ì¡°íšŒ ëŒ€ìƒì„ ì§€ì •í•´ì„œ ê°€ì ¸ ì˜¤ë ¤ë©´,

```java
  cq.multiselect(m.get("username"), m.get("age"))
```

`cb.array` ë¥¼ ì“°ëŠ” ë°©ë²•ì€

```java
CriteriaBuilder db = em.getCriteriaBuilder();
cq.select(cb.array(m.get("username"), m.get("age")));
```

#### DISTINCT

```java
Ciriteriaquery<Object[]> cq = cb.createQuery(Object[].class);
Root<Member> m = cq.from(Member.class);
cq.multiselect(m.get("username"), m.get("age")).distinct(true);

TypedQuery<Object[]> query = em.createQuery(cq);
List<Object[]> resultList = query.getResultList();
```

### NEW, construct()

JPQLì—ì„œ `new ìƒì„±ì()` êµ¬ë¬¸ì€ `cb.contruct(Class<?>, ...)` ë¡œ ì‚¬ìš© í•  ìˆ˜ ìˆëŒ€ìš”.

```java
CriteriaQuery<MemberDTO> cq = cb.createQuery(MemberDTO.class);
Root<Member> m = cq.from(Member.class);

cq.select(cb.construct(MemberDTO.class, m.get("username"), m.get("age")));

TypedQuery<MemberDTO> query = em.createQuery(cq);
List<MemberDTO> resultList = query.getResultList();
```

### íŠœí”Œ

`Map` í•˜ê³  ë¹„ìŠ·í•œ ê±°ë˜ìš”.

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Tuple> cq = cb.createTupleQuery();
Root<Member> m = cq.from(Member.class);
cq.multiselect(
  m.get("username").alias("name"),
  m.get("age").alias("na-e")
);

TypedQuery<Tuple> query = me.createQuery(cq);
List<Tuple> resultList = query.getResultList();
for (Tuple tuple : resultList) {
  String username = tuple.get("name", String.class);
  Integer age = tuple.get("na-e", Integer.class);
}
```

íŠœí”Œì˜ ë³„ì¹­ë„ ì“¸ìˆ˜ ìˆë„¤ìš”.  
ì—”í‹°í‹°ë¥¼ íŠœí”Œì—ì„œ êº¼ë‚¼ ìˆ˜ë„ ìˆê³ ìš”.

### 3.4 ì§‘í•©

#### GROUP BY

íŒ€ ì´ë¦„ë³„ë¡œ ë‚˜ì´ê°€ ê°€ì¥ ë§ì€ ì‚¬ëŒê³¼ ì ì€ ì‚¬ëŒ êµ¬í•˜ê¸°  
JPQLì€ ì´ë ‡ê³ ,

```SQL
    SELECT m.team.name,
           MAX(m.age),
           MIN(m.age)
      FROM Member m
  GROUP BY m.team.name

```

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Object[]> cq = cb.createQuery(Object[].class);
Root<Member> m = cq.from(Member.class);

Expression maxAge = cb.max(m.<Integer>get("age"));
Expression minAge = cb.min(m.<Integer>get("age"));

cq.multiselect(m.get("team").get("name"), maxAge, minAge);
cq.groupBy(m.get("team").get("name"));

TypedQuery<Object[]> query = em.createQuery(cq);
List<Object[]> resultList = query.getResultList();
```

### HAVING

ìœ„ì™€ ê°™ì€ ì¡°ê±´ì—ì„œ ê°€ì¥ ë‚˜ì´ì–´ë¦° ì‚¬ëŒì´ 10ì„¸ ì´ˆê³¼í•˜ëŠ” íŒ€ì€

```java
  .groupBy( ... )
  .having(cb.gt(minAge, 10))
```

### 3.5 ì •ë ¬

```java
  cq.select(m)
    .where(ageGt)
    .orderBy(cb.desc(m.get("age")));
```

### 3.6 ì¡°ì¸

`JoinType` ì€ enum ìœ¼ë¡œ ì†ì„±ì´ `INNER`, `LEFT`, `RIGHT` ê°€ ìˆì–´ìš”.  
JPQL ë¡œ,

```SQL
    SELECT m, t
      FROM Member m
INNER JOIN m.team t
     WHERE t.name = 'A'
```

```java
Root<Member> m = cq.from(Member.class);
Join<Member, Team> t = m.join("team", JoinType.INNER);

cq.multiselect(m, t)
  .where(cb.equal(t.get("name"), "A"));
```

**_FETCH JOIN_** ì€,

```java
Root<Member> m = cq.from(Member.class);
m.fetch("team", JoinType.LEFT);
```

ì´ëŸ¬ë©´ ë˜ê³ , ì¡°ì¸ í• ë•Œ ì£¼ì˜ í• ê±´ JPQL ë•Œë‘ ë˜‘ê°™ëŒ€ìš”.

### 3.7 ì„œë¸Œ ì¿¼ë¦¬

ë‹¨ìˆœí•œ ì„œë¸Œ ì¿¼ë¦¬ë¥¼ JPQLì€,

```SQL
SELECT m
  FROM Member m
 WHERE m.age > (  SELECT AVG(m2.age)
                    FROM Member m2  )
```

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> mainQuery = cb.createQuery(Member.class);

Subquery<Double> subQuery = mainQuery.subquery(Double.class);
Root<Member> m2 = subQuery.from(Member.class);
subQuery.select(cb.avg(m2.<Integer>get("age")));

Root<Member> m = mainQuery.from(Member.class);
mainQuery.select(m)
         .where(cb.ge(m.<Integer>get("age"), subQuery));
```

ë³µì¡í•´. ì´ë¯¸ ë³µì¡í•œë°, ìƒí˜¸ ê´€ë ¨ ì„œë¸Œ ì¿¼ë¦¬ê°€ ë˜ ìˆëŒ€ìš”.

```SQL
  SELECT m
    FROM Member m
   WHERE EXISTS (  SELECT t
                     FROM m.team t
                    WHERE t.name = 'A'  )
```

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> mainQuery = cb.createQuery(Member.class);
Root<Member> m = mainQuery.from(Member.class);

SubQuery<Team> subQuery = mainQuery.subquery(Team.class);
Root<Member subM = subQuery.correlate(m);

Join<Member, Team> t = subM.join("team")
subQuery.select(t)
        .where(cb.equal(t.get("name"), "A"))

mainQuery.select(m)
         .where(cb.exists(subQuery));

List<Member> members = em.createQuery(mainQuery).getResultList();
```

### 3.8 IN ì‹

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> cq = cb.createQuery(Member.class);
Root<Member> m = cq.from(Member.class);

cq.select(m)
  .where(cb.in(m.get("username"))
           .value("name1")
           .value("name2"));
```

### 3.9 CASE ì‹

```java
Root<Member> m = cq.from(Member.class);

cq.multiselect(m.get("username"),
  cb.selectCase()
    .when(cb.ge(m.<Integer>get("age"), 60), "ELDER")
    .when(cb.le(m.<Integer>get("age"), 15), "YOUNGER")
    .otherwise("ADULT")
);
```

### 3.10 íŒŒë¼ë¯¸í„° ì •ì˜

```java

Root<Member> m = cq.from(Member.class);

cq.select(m)
  .where(cb.equal(m.get("username"), cb.parameter(String.class, "usernameParam")));

List<Member> members = em.createQuery(cq)
                         .setParameter("usernameParam", "greenb")
                         .getResultList();
```

íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ë³µì¡í•¨ğŸ‘  
ë¬´ì¡°ê±´ `PreparedStatement` ë¡œ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ëœëŒ€ìš”.

### 3.11 ë„¤ì´í‹°ë¸Œ í•¨ìˆ˜ í˜¸ì¶œ

```java
Root<Member> m  = cq.from(Member.clss);
Expression<Long> function = cb.function("SUM", Long.class, m.get("age"));

cq.select(function);
```

IDE ì—†ì¸ ì ˆëŒ€ ëª»ì¨ë¨¹ì„ê±° ê°™ìŒ...â˜¹ï¸

### 3.12 ë™ì  ì¿¼ë¦¬

```java
Integer age = 10;
String username = null;
String teamName = "A";

CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> cq = cb.createQuery(Member.class);
Root<Member> m = cq.from(Member.class);
Join<Member, Team> t = m.join("team");

List<Predicate> criteria = new ArrayList<>();

if (age != null) criteria.add(cb.equal(m.<Integer>get("age"), cb.parameter(Integer.class, "age")));
if (username != null) criteria.add(cb.equal(m.get("username"), cb.parameter(String.class, "username")));
if (teamName != null) criteria.add(cb.equal(t.get("name"), cb.parameter(String.class, "teamName")));

cq.where(cb.and(criteria.toArray(new Predicate[0])));

TypedQuery<Member> query = em.createQuery(cq);
if (age != null) query.setParameter("age", age);
if (username != null) query.setParameter("username", username);
if (teamName != null) query.setParameter("teamName", teamName);

List<Member> members = query.getResultList();
```

ëŒ€ë°•! mdì— ì²˜ìŒìœ¼ë¡œ ì´ë ‡ê²Œ ê¸´ ì½”ë“œ ë„£ì–´ë³´ëŠ” ë“¯...

### 3.13 í•¨ìˆ˜ ì •ë¦¬

`m.get("username").isNull()` ì´ë ‡ê²Œ ì“°ëŠ” í•¨ìˆ˜ìš”.

**_ì¡°ê±´ í•¨ìˆ˜_** ëŠ”,
|í•¨ìˆ˜ëª…|JPQL|
|-|-|
|and()|AND|
|or()|OR|
|not()|NOT|
|equal(), notEqual()| =, <>|
|lt(), lessThan()| < |
|le(), lessThanOrEqualTo()| <= |
|gt(), greaterThan()| > |
|ge(), greaterThanOrEqualTo()| >= |
|between()| BETWEEN|
|like(), notLike()|LIKE, NOT LIKE|
|isTrue(), isFalse()| IS TRUE, IS FALSE|
|in(), not(in())|IN, NOT IN()|
|exists(), not(exists())|EXISTS, NOT EXISTS|
|isNull(), isNotNull()| IS NULL, IS NOT NULL|
|isEmpty(), isNotEmpty()|IS EMPTY, IS NOT EMPTY|
|isMember(), isNotMember()|MEMBER OF, NOT MEMBER OF|

**_ìŠ¤ì¹¼ë¼ì™€ ê¸°íƒ€ í•¨ìˆ˜_** ëŠ”,
|í•¨ìˆ˜ëª…|JPQL|
|-|-|
|sum()| +|
|neg(), diff()| - |
|prod()| \* |
|quot()| / |
|all()| ALL |
|any()| ANY |
|some()| SOME |
|abs()| ABS |
|sqrt()| SQRT |
|mod()| MOD |
|size()| SIZE |
|length()|LENGTH|
|locate()|LOCATE|
|concat()|CONCAT|
|upper()|UPPER|
|lower()|LOWER|
|substring()|SUBSTRING|
|trim()|TRIM|
|currentDate()|CURRENT_DATE|
|currentTime()|CURRENT_TIME|
|currentTimestamp()|CURRENT_TIMESTAMP|

**_ì§‘í•© í•¨ìˆ˜_** ëŠ”,
|í•¨ìˆ˜ëª…|JPQL|
|-|-|
|avg()|AVG|
|max(), greatest()|MAX|
|min(), least()|MIN|
|sum(),sumAsLong(),sumAsDouble|SUM|
|count()|COUNT|
|countDistinct()|COUNT DISTINCT|
|nullif()|NULLIF|
|coalesce()|COALESCE|
|selectCase()|CASE|

### 3.14 Criteria ë©”íƒ€ ëª¨ë¸ API

ì—”í‹°í‹°ì˜ í•„ë“œëª…ì„ ë¬¸ìí˜•ìœ¼ë¡œ ì‘ì„±í•˜ë‹¤ë³´ë©´ ì˜¤íƒ€ ë“±ì˜ ì‹¤ìˆ˜ë¥¼ ëŸ°íƒ€ì„ ì‹œì ì— ë°œê²¬í•˜ê²Œ ë˜ê³¤ í•  ìˆ˜ ìˆì–´ì„œ, ë©”íƒ€ ëª¨ë¸ì„ ì‚¬ìš©í•˜ë©´ ê·¸ëŸ´ ì¼ì´ ì—†ê³ , ì„±ê°€ì‹  ì œë„¤ë¦­ ë¬¸ë²•ë„ ì—†ì•¨ ìˆ˜ ìˆëŠ” ê²ƒ ê°™ë„¤ìš”.  
`pom.xml` ì—,

```xml
  <depencencies>
    <dependency>
      <groupId>org.hibernate</groupId>
      <artifactId>hibernate-jpamodelgen</artifactId>
    </dependency>
  </depencencies>

      <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                  <compilerArguments>
                    <processor>org.hibernate.jpamodelgen.JPAMetaModelEntityProcessor</processor>
                  </compilerArguments>
                </configuration>
            </plugin>
        </plugins>
    </build>
```

ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ë©´ ë©”íƒ€ ëª¨ë¸ í´ë˜ìŠ¤ ìƒì„±ì„ í•  ìˆ˜ ìˆëŒ€ìš”.

<br>

## 4. QueryDSL

### 4.1 QueryDSL ì„¤ì •

í™˜ê²½ì„¤ì •ì€ ìµœì‹ í™”ë¥¼ ìœ„í•´ì„œ http://www.querydsl.com ì— ê°€ë³´ëŠ”ê²Œ ì¢‹ì„ ê²ƒ ê°™ë„¤ìš”.

ë‚˜ë¨¸ì§€ëŠ” ì½”ë“œë¡œ ëŒ€ì‹ í• ê²Œìš”. ê° ì˜ˆì œë“¤ì„ ì‹¤ì œë¡œ ì‘ì„±í•´ì„œ ë™ì‘ì‹œì¼œ ë³´ê³  ì‹¶ë„¤ìš”.
https://

### 4.4 ê²°ê³¼ ì¡°íšŒ

- `uniqueResult()` ë‹¨ê±´ ì¡°íšŒ
- `singleResult()` ë‹¨ê±´ ì¡°íšŒ (ë‹¤ê±´ì´ë©´ ì²«ë²ˆì§¸ ë°ì´í„° ë°˜í™˜)
- `list()` ë‹¤ê±´ ì¡°íšŒ (ê²°ê³¼ ì—†ìœ¼ë©´ ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜)

### 4.12 ë©”ì†Œë“œ ìœ„ì„

```java
public class ITemExpression {

  @QueryDelegate(Item.class)
  public static BooleanExpression isExpensive(QItem item, Integer price) {
    return item.price.gt(price);
  }
}
```

ì´ë ‡ê²Œ ì„ ì–¸í•˜ê³ ,

```java
public class QItem extends EntityPathBase<Item> {
  ...

  public com.mysema.query.types.expr.BooleanExpression isExpensive(Integer price) {
    return ItemExpression.isExpensive(this, price);
  }
}
```

ì´ë ‡ê²Œ generated ëœ `QItem` ì— ìˆ˜ì •í•˜ë©´,

```java
query.from(item).where(item.isExpensive(300))
```

ì´ë ‡ê²Œ ì“¸ ìˆ˜ ìˆëŒ€ìš”.

<br>

## 5. ë„¤ì´í‹°ë¸Œ SQL

íŠ¹ì • DBMS ì—ì„œë§Œ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥ ë•Œë¬¸ì— ì“¸ ìˆ˜ ìˆëŒ€ìš”.

### 5.1 ë„¤ì´í‹°ë¸Œ SQL ì‚¬ìš©

```java
Query nq = em.createNativeQuery(sql, Member.class)
    .setParameter(1, 20);

List<Member> members = nq.getResultList();
```

ì œë„¤ë¦­ì„ ì•ˆì“°ë©´ `Object[]` í˜•íƒœë¡œ ë‚˜ì˜¨ëŒ€ìš”.
ê²°ê³¼ë¥¼ ë§¤í•‘í•˜ëŠ” `@SqlResultSetMapping` ë„ ìˆê³ ìš”.
`@EntityResult` ì™€ `@FieldResult`, `@ColumnResult` ë¡œ ì ì ˆíˆ ë§¤í•‘ì„ êµ¬ì„±í•  ìˆ˜ ìˆêµ°ìš”.

### 5.2 Named ë„¤ì´í‹°ë¸Œ SQL

`@NamedNativeQuery` ë¡œ ì“¸ìˆ˜ ìˆêµ°ìš”.

### 5.3 ë„¤ì´í‹°ë¸Œ SQL XMLì— ì •ì˜

```XML
<entity-mappings ...>
  <named-native-query
      name="..."
      result-set-mapping="sampleRSMapping">
    <query><![CDATA[
        SELECT ...
    ]]></query>
  </named-native-query>

  <sql-result-set-mapping name="sampleRSMapping">
    <entity-result entity-class="jpabook.domain.Member" />
    <column-result name="ORDER_COUNT" />
  </sql-result-set-mapping>
```

ì´ë ‡ê²Œ ì •ì˜ í•  ìˆ˜ ìˆëŒ€ìš”.

### 5.4 ë„¤ì´í‹°ë¸Œ SQL ì •ë¦¬

SQL ê´€ë¦¬ê°€ ì‰½ì§€ ì•Šê³ , íŠ¹ì • DBMS ì— ì¢…ì†ì ì´ê¸° ë•Œë¬¸ì— ìì œí•˜ë€ ë§ì”€

### 5.5 ìŠ¤í† ì–´ë“œ í”„ë¡œì‹œì €(JPA 2.1)

í”„ë¡œì‹œì €ë„ ì‚¬ìš© í•  ìˆ˜ ìˆë„¤ìš”.

<br>

## 6. ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì‹¬í™”

### 6.1 ë²Œí¬ ì—°ì‚°

ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  DBì— ì§ì ‘ ì¿¼ë¦¬í•œëŒ€ìš”!!  
ë²Œí¬ ì—°ì‚° í›„ì—ëŠ” `em.refresh()` ë¥¼ ì‹¤í–‰í•´ì•¼ ì •í™•í•œ ì •ë³´ë¡œ ë‹¤ì‹œ ì¡°íšŒ ëœëŒ€ìš”.

### 6.2 ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ JPQL

#### ì¿¼ë¦¬ í›„ ì˜ì† ìƒíƒœì¸ ê²ƒê³¼ ì•„ë‹Œ ê²ƒ

#### JPQLë¡œ ì¡°íšŒí•œ ì—”í‹°í‹°ì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸

#### find() vs JPQL

### 6.3 JPQLê³¼ í”ŒëŸ¬ìŠ¤ ëª¨ë“œ

#### ì¿¼ë¦¬ì™€ í”ŒëŸ¬ì‹œ ëª¨ë“œ

#### í”ŒëŸ¬ì‹œ ëª¨ë“œì™€ ìµœì í™”

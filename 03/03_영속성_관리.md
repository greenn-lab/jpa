# 03. ì˜ì†ì„± ê´€ë¦¬

## ëª©ì°¨
1. ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì™€ ì—”í‹°í‹° ë§¤ë‹ˆì €
2. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë€?
3. ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ íŠ¹ì§•
5. í”ŒëŸ¬ì‹œ
6. ì¤€ì˜ì†


## 1. ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì™€ ì—”í‹°í‹° ë§¤ë‹ˆì €
```java
// ë§ì€ ë¹„ìš© ë°œìƒ
EntityManagerFactory emf = 
    Persistance.createEntityManagerFactory("jpabook");

// ë¹„ìš©ì´ ê±°ì˜ ì•ˆë“¬
EntityManager em = emf.createManager();
```

> `EntityManagerFactory` ëŠ” `EntityManager`ë¥¼  ë§Œë“œëŠ” ê³µì¥.
> ë¹„ìš©ì´ ìƒë‹¹íˆ í¬ê¸° ë•Œë¬¸ì— **í•œ ê°œë§Œ ë§Œë“¤ì–´ì„œ** ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì— ê³µìœ í•˜ë„ë¡ ì„¤ê³„ ë¨.

> ê·¸ë¦¬ê³ , `EntityManagerFactory` ëŠ” ì—¬ëŸ¬ Thread-safe. í•˜ì§€ë§Œ `EntityManager` ëŠ” ë™ì‹œì„± ë¬¸ì œ ë°œìƒìœ¼ë¡œ Non-thread-safe

## 2. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(Persistence Context)ë€?
ì—”í‹°í‹°ë¥¼ **ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½**
```java
// EntityManagerë¥¼ ì´ìš©í•´ì„œ íšŒì› ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥
em.persist(member);
```

## 3. ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°
| ìƒíƒœ                     | ì„¤ëª…                      |
| ---------------------- | ----------------------- |
| __ë¹„ì˜ì†__(new/transient) | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒíƒœ  |
| __ì˜ì†__(managed)        | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ìƒíƒœ        |
| __ì¤€ì˜ì†__(detached)      | ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ |
| __ì‚­ì œ__(removed)        | ì‚­ì œëœ ìƒíƒœ                  |
![ìƒëª…ì£¼ê¸°](01_life_cycle.png)

#### ë¹„ì˜ì†
```java
// ê°ì²´ë¥¼ ìƒì„±í•œ ìƒíƒœ(ë¹„ì˜ì†)
Member member = new Member();
member.setId("greenb");
member.setUsername("ê·¸ë¦°ë¹„");
```

#### ì˜ì†
`EntityManager.persist()` ë¥¼ í†µí•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥.
```java
// ê°ì²´ë¥¼ ì €ì¥í•œ ìƒíƒœ(ì˜ì†)
em.persist(member);
```

#### ì¤€ì˜ì†
"ì˜ì†" ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ê´€ë¦¬ìí•˜ì§€ ì•ŠëŠ” ê²ƒ(=ë¶„ë¦¬í•˜ëŠ” ê²ƒ).
```java
// íšŒì› ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬(ì¤€ì˜ì†)
em.detach(member);
```

#### ì‚­ì œ
ì—”í‹°í‹°ë¥¼ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**ì™€ **RDB**ì—ì„œ ì‚­ì œ.
```java
// ê°ì²´ë¥¼ ì‚­ì œ
em.remove(member);
```

## 4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ íŠ¹ì§•
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì‹ë³„ì ê°’
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì—”í‹°í‹°ë¥¼ êµ¬ë³„í•  ë•Œ ì‹ë³„ì ê°’ ì´ìš© `@Id` 
  - ë°˜ë“œì‹œ ìˆì–´ì•¼í•¨. ì—†ìœ¼ë©´ Exception!
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ RDB ì €ì¥
  - JPAëŠ” ë³´í†µ `íŠ¸ëœì­ì…˜ ì»¤ë°‹` ìˆœê°„ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ RDBì— ë°˜ì˜
  - ì´ê²ƒì„ `flush` ë¼ê³  í•¨
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—”í‹°í‹°ë¥¼ ê´€ë¦¬í•˜ë©´ì„œ ë°œìƒí•˜ëŠ” ì´ì 
  - 1ì°¨ ìºì‹œ
  - ë™ì¼ì„± ë³´ì¥ (ê°™ì€ ê°ì²´ ë°˜í™˜ ;ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ ê°™ì€)
  - íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°
  - ë³€ê²½ ê°ì§€
  - ì§€ì—° ë¡œë”©

### 4.1 ì—”í‹°í‹° ì¡°íšŒ
```java
// ì—”í‹°í‹° ê°ì²´ë¥¼ ìƒì„±í•œ ìƒíƒœ(ë¹„ì˜ì†)
Member member = new Member();
member.setId("greenb");
member.setUsername("ê·¸ë¦°ë¹„");

// ì—”í‹°í‹° ê°ì²´ë¥¼ ì˜ì†
em.persist(member);
```
**1ì°¨ ìºì‹œ**ì˜ í‚¤ëŠ” ***ì‹ë³„ì ê°’***. ê·¸ë¦¬ê³  RDBì˜ ê¸°ë³¸ í‚¤(Primary Key)ì™€ ë§¤í•‘ë˜ì–´ ìˆìŒ.

```java
// ì—”í‹°í‹°ë¥¼ ì¡°íšŒ
Member member = em.find(Member.class, "greenb");
```
```java
// EntityManager.find() ëª…ì„¸
public <T> find(Class<T> entityClass, Object primaryKey);
```

`em.find()` ë¥¼ í˜¸ì¶œí•˜ë©´, 1ì°¨ ìºì‹œì—ì„œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ.  
ë§Œì•½ ì°¾ëŠ” ì—”í‹°í‹°ê°€ ì—†ìœ¼ë©´ RDBì—ì„œ ì¡°íšŒ.
```java
Member member = new Member();
member.setId("greenb");
member.setUsername("ê·¸ë¦°ë¹„");

// 1ì°¨ ìºì‹œì— ì €ì¥
em.persist(member);

// 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
Member a = em.find(Member.class, "greenb");
Member b = em.find(Member.class, "greenb");

System.out.println(a == b); // true
```
### 4.3 ì—”í‹°í‹° ë“±ë¡
```java
EntityManager em = emf.createEntityManager();
EntityTransaction tx = em.getTransaction();

// EntityManager ëŠ” ë°ì´í„° ë³€ê²½ ì‹œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘
tx.begin();

em.persist(memberA);
em.persist(memberB); // ì•„ì§ RDBì— INSERT ì•ˆí•˜ê³  ìˆìŒ

tx.commit(); // ì§€ê¸ˆ ì´ ìˆœê°„~ğŸµ, RDBì— INSERT í•¨
```
`EntityManager` ëŠ” "ë‚´ë¶€ ì¿¼ë¦¬ ì €ì¥ì†Œ"ì— INSERT SQLì„ ëª¨ì•„ë‘ .  
ê·¸ë¦¬ê³  íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë  ë•Œ ëª¨ì•„ë‘” ì¿¼ë¦¬ë¥¼ í•œêº¼ë²ˆì— RDBë¡œ ë³´ëƒ„.
ì´ê²ƒì´ íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—° *transactional write-behind* ì´ë¼ í•¨.


